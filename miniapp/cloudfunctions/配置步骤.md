# 微信云开发配置步骤（详细版）

## 一、开通云开发（5分钟）

### 1. 登录微信公众平台
- 访问：https://mp.weixin.qq.com/
- 使用管理员微信扫码登录

### 2. 进入云开发
1. 左侧菜单找到"云开发"
2. 点击"开通"
3. 填写信息：
   - **环境名称**：填写 `tryon-prod`（或任意名称）
   - **环境ID**：系统自动生成（格式如：`cloud1-xxx`）
   - **付费方式**：选择"按量付费"
   - **绑定银行卡**：只是预授权，不会扣费

4. 同意协议，点击"开通"
5. **记录下你的环境ID**（后面要用）

### 3. 设置用量告警（避免意外扣费）
1. 在云开发控制台，点击"设置"
2. 找到"用量告警"
3. 设置告警阈值：
   - 云函数调用次数：8万次（80%）
   - 云函数资源使用：3万GBs（75%）
   - 流量：800MB（80%）
4. 填写告警邮箱/手机

---

## 二、配置小程序环境ID（1分钟）

打开文件：`miniapp/src/app.ts`

将第12行的 `your-env-id` 替换为你的实际环境ID：

```typescript
Taro.cloud.init({
  env: 'cloud1-xxx', // 👈 改成你的环境ID
  traceUser: true
});
```

---

## 三、上传云函数（3分钟）

### 1. 打开微信开发者工具
- 导入 `miniapp` 目录作为项目
- 使用你的小程序AppID

### 2. 找到云函数目录
- 在左侧文件树中，找到 `cloudfunctions` 文件夹
- 如果没有显示，右键项目根目录 → "在外部终端窗口打开" → 确认 `cloudfunctions` 存在

### 3. 配置云函数根目录
1. 点击微信开发者工具右上角的"详情"
2. 找到"本地设置"
3. 勾选"启用云函数"
4. **云函数目录**：输入 `cloudfunctions`

### 4. 上传云函数
1. 现在左侧文件树中应该会显示云函数图标（云朵☁️）
2. 右键点击 `generateTryOn` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待上传完成（约1-2分钟）

> ⚠️ 注意：必须选择"云端安装依赖"，否则 axios 等依赖不会被安装

---

## 四、配置云函数环境变量（2分钟）

### 1. 打开云开发控制台
- 在微信开发者工具中，点击顶部工具栏的"云开发"按钮
- 或直接访问：https://console.cloud.tencent.com/tcb

### 2. 进入云函数管理
1. 点击左侧"云函数"
2. 找到 `generateTryOn` 函数
3. 点击函数名称，进入详情页

### 3. 配置环境变量
1. 点击"函数配置"标签页
2. 找到"环境变量"部分
3. 点击"编辑"
4. 添加以下3个环境变量：

| 变量名 | 变量值 |
|--------|--------|
| `ARK_API_KEY` | `3ecc5d48-8986-4027-a052-2f63010e2f3d` |
| `ARK_BASE_URL` | `https://ark.cn-beijing.volces.com/api/v3` |
| `ARK_MODEL` | `doubao-seedream-4-0-250828` |

5. 点击"保存"

> 💡 提示：`ARK_API_KEY` 的值来自你的 `web/.env.local` 文件

### 4. 重启云函数（重要！）
- 环境变量修改后，需要重启云函数才能生效
- 在函数列表中，点击"重启"按钮

---

## 五、测试云函数（可选，2分钟）

### 在云开发控制台测试
1. 进入云函数详情页
2. 点击"云端测试"标签
3. 输入测试参数：

```json
{
  "personBase64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
  "garmentBase64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
}
```

4. 点击"测试"
5. 查看返回结果（如果有错误，查看日志）

> 💡 上面的是1x1像素的测试图片，只用来测试云函数是否正常，不会生成真实效果

---

## 六、小程序端测试（3分钟）

### 1. 编译小程序
- 在微信开发者工具中，点击"编译"
- 查看控制台，应该看到"云开发初始化成功"

### 2. 测试流程
1. 点击"选择您的照片" → 从相册选择一张人物照片
2. 点击"选择服装图片" → 从相册选择一张服装图片
3. 点击"生成试穿效果"
4. 等待30-120秒（第一次可能较慢）
5. 查看生成结果

### 3. 查看日志（如果出错）
- 微信开发者工具控制台 → Console标签
- 或云开发控制台 → 云函数 → generateTryOn → 日志

---

## 常见问题排查

### ❌ 问题1：云函数上传失败
**症状**：右键没有"上传并部署"选项

**解决**：
1. 检查是否启用了云函数：详情 → 本地设置 → 勾选"启用云函数"
2. 检查云函数目录设置是否为 `cloudfunctions`
3. 重启微信开发者工具

---

### ❌ 问题2：调用云函数失败，提示"env parameter is not valid"
**症状**：控制台报错环境ID无效

**解决**：
1. 检查 `app.ts` 中的环境ID是否正确
2. 确保环境ID格式为 `cloud1-xxx`（不是环境名称）
3. 重新编译小程序

---

### ❌ 问题3：云函数返回"ARK_API_KEY未配置"
**症状**：生成失败，错误信息提示API密钥未配置

**解决**：
1. 确认在云函数配置中添加了环境变量
2. 检查变量名是否正确（区分大小写）
3. **重启云函数**（这一步很重要！）

---

### ❌ 问题4：生成时间过长或超时
**症状**：loading一直显示，最后超时

**解决**：
1. 火山引擎API响应较慢（30-120秒）是正常的
2. 可以增加云函数超时时间：
   - 云函数配置 → 高级配置 → 执行超时时间 → 改为180秒
3. 检查网络连接
4. 查看云函数日志，确认是否真的在执行

---

### ❌ 问题5：真机预览无法调用云函数
**症状**：开发者工具正常，真机预览失败

**解决**：
1. 确保手机网络正常
2. 在小程序后台配置服务器域名：
   - 登录微信公众平台
   - 开发 → 开发管理 → 开发设置 → 服务器域名
   - request合法域名中添加：`https://api.weixin.qq.com`
3. 检查云函数是否已上传到云端

---

## 费用监控

### 查看用量
1. 打开云开发控制台
2. 点击"统计分析"
3. 查看各项资源使用情况

### 免费额度参考
- **云函数调用**：10万次/月
- 平均每天可调用：3,333次
- 如果每次生成算1次：可生成10万张图/月

对于学习和测试，完全够用！

---

## 下一步

配置完成后，你就可以：
1. ✅ 在小程序中真实体验虚拟试穿功能
2. ✅ 分享给朋友测试
3. ✅ 继续优化功能和UI

如有问题，查看：
- 微信开发者工具控制台日志
- 云开发控制台 → 云函数 → 日志
- 本文档的"常见问题排查"部分
